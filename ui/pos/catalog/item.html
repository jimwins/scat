{% extends 'catalog/page.html' %}
{% import 'macros.twig' as scat %}

{% block title %}
  Item: {{ item.title }}
{% endblock %}

{% block catalog_crumb_button %}
  {% if item.product_id %}
    {# we undo the styling of x-editable on this button #}
    <style>.editable-noclick { border-bottom: inherit }</style>
    <button class="btn btn-default editable-select2 editable-noclick"
            data-type="select2" data-name="product_id">
      <i class="fa fa-cog"></i>
    </button>
  {% endif %}
{% endblock %}

{% block catalog_crumb %}
  {% if item.product_id %}
    {% set product= item.product %}
    {% set subdept= product.dept %}
    {% set dept= subdept.parent %}
    {{ parent() }}
  {% else %}
    <ol class="breadcrumb">
      <li><a href="{{ url_for('catalog') }}">Catalog</a></li>
      <li>
        <span class="editable-select2"
              data-type="select2"
              data-name="product_id">
          No Product
        </span>
      </li>
    </ol>
  {% endif %}
{% endblock %}

{% block catalog_sidebar %}
{% endblock %}

{% block catalog_width "12" %}

{% block catalog_content %}

  {% block header %}
    <div id="header" data-reload="header">
      <h2 class="page-header" style="margin-top: 0.5em">
        <span class="pull-right">
          <button type="button" class="btn btn-link toggle"
                  data-name="active" data-value="{{ item.active }}" data-reload-block="header">
            <i class="fa fa-fw {{ item.active ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
            Active
          </button>
          <a class="btn btn-link"
             href="{{ PUBLIC ~ '/' ~ item.code }}"
             target="_blank">
            <i class="fa fa-external-link"></i>
            <span class="sr-only">Item on public website</span>
          </a>
          <span class="editable text-muted" data-name="code">
            {{- item.code -}}
          </span>
        </span>
        {# we edit item.name, but display item.title #}
        <span class="editable" data-name="name" data-value="{{ item.name }}" style="{{ item.active ?: 'text-decoration: line-through' }}">
          {{- item.title -}}
        </span>
      </h2>
    </div>
  {% endblock %}

  <div class="row">
    <div class="col-sm-3">
      {{ block('media') }}
    </div>
    <div class="col-sm-9">
      <div class="col-sm-4">
        {{ block('pricing') }}
      </div>
      <div class="col-sm-4">
        {{ block('stock') }}
      </div>
      <div class="col-sm-4">
        {{ block('details') }}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Description</h3>
        </div>
        <div class="panel-body">
          <span class="editable" data-name="description" data-editable-type="textarea" data-placement="bottom" data-value="{{ item.description | e('html_attr') }}">
            {{- (item.description ?? "") | markdown_to_html -}}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">

    <div class="col-md-3">

      <!-- Barcodes -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Barcodes</h3>
        </div>
        {% block barcodes %}
          <table id="barcodes" data-reload="barcodes"
                 class="table table-striped">
            <tbody>
              {% for barcode in item.barcodes.find_many %}
                <tr>
                  <td>
                    {{ barcode.code }}
                  </td>
                  <td class="edit-barcode-quantity"
                      data-pk="{{ barcode.code }}"
                      data-name="quantity">
                    {{- barcode.quantity -}}
                  </td>
                  <td>
                    <button type="button"
                            class="btn btn-default btn-xs remove-barcode"
                            data-barcode="{{ barcode.code }}">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endblock %}

        <div class="panel-footer">
          <button id="new-barcode" class="btn btn-default">
            <i class="fa fa-barcode"></i> New
          </button>
          <div class="btn-group hidden-print">
            <button type="button" class="btn btn-default" data-action="print-labels">
              <i class="fa fa-print"></i> Print Label
            </button>
            <button type="button" class="btn btn-default dropdown-toggle"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a data-action="print-labels" data-quantity="ask">
                  Multiple
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-noprice="1">
                  No price
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-noprice="1" data-quantity="ask">
                  No price, multiple
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-trim="ask">
                  Trim name
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-trim="ask" data-noprice="1">
                  Trim name, no price
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-short="1">
                  Short name
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-short="1" data-noprice="1">
                  Short name, no price
                </a>
              </li>
              <li>
                <a data-action="print-labels" data-size="half" data-trim="ask">
                  Half-size price label
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

    </div>

    <div class="col-sm-3">

      <!-- Sales -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Sales</h3>
        </div>
        <div class="panel-body form-horizontal">

          <div class="form-group">
            <label for="quarter" class="col-sm-6 control-label">
             Last 3 Months
            </label>
            <div class="col-sm-6">
              <p class="form-control-static" id="quarter">
                {% set sales= item.recent_sales(90) %}
                {% if sales.units %}
                  {{ scat.amount(sales.gross) }}
                  ({{ sales.units }})
                {% else %}
                  None
                {% endif %}
              </p>
            </div>
          </div>

          <div class="form-group">
            <label for="year" class="col-sm-6 control-label">
             Last Year
            </label>
            <div class="col-sm-6">
              <p class="form-control-static" id="year">
                {% set sales= item.recent_sales(365) %}
                {% if sales.units %}
                  {{ scat.amount(sales.gross) }}
                  ({{ sales.units }})
                {% else %}
                  None
                {% endif %}
              </p>
            </div>
          </div>

          <div class="form-group">
            <label for="margin" class="col-sm-6 control-label">
              Google
              <a target="_blink"
                href="https://merchants.google.com/mc/items/details?a={{ config('google.merchant_center_id') }}&offerId={{ item.code }}&language=en&channel=0&country=US&pli=1">
                <i class="fa fa-google fa-fw"></i>
              </a>
            </label>
            <div class="col-sm-6">
              <button class="btn btn-sm btn-default"
                      data-action="google-history">
                <i class="fa fa-fw fa-line-chart"></i> Activity
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>

    {% set kits= item.in_kits %}
    {% if kits|length %}
      <div class="col-sm-3">
        <!-- Kits -->
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">In Kits</h3>
          </div>
          <ul class="list-group">
            {% for kit in kits %}
              <a class="list-group-item"
                  href="{{ url_for('catalog-item', { 'code' : kit.code }) }}">
                {{ kit.name }}
              </a>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    {% if item.variation != '' %}
      {% set variations= item.variations() %}
      {% if variations|length %}
        <div class="col-sm-6">
          <!-- Variations -->
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Variations</h3>
            </div>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Variation</th>
                  <th>Quantity</th>
                  <th>Sale Price</th>
                </tr>
              </thead>
              <tbody>
                {% for i in variations %}
                  <tr class="{{ i.minimum_quantity == 0 ? 'text-muted' }}">
                    <td>
                      <a href="{{ url_for('catalog-item', { 'code' : i.code }) }}">
                        {{- i.code -}}
                      </a>
                    </td>
                    <td>
                      {{ i.variation }}
                    </td>
                    <td>
                      {{ i.stock }}
                    </td>
                    <td>
                      {{ scat.amount(i.sale_price) }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    {% endif %}

  </div><!-- .row -->

  <div>
    {% if item.is_kit %}
      <!-- Kit Contents -->
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="kitHeader">
          <a class="accordion-toggle collapsed" role="button" data-toggle="collapse" href="#kit" aria-expanded="false" aria-controls="kit">
            <h4 class="panel-title">Kit Contents</h4>
          </a>
        </div>
        <div id="kit" data-reload="kit"
             class="panel-collapse collapse collapsed"
             role="tabpanel" aria-labelledby="kitHeader">
          {% block kit %}
            {% import 'macros.twig' as scat %}
            <div>{# has to be one html element for scat.reload() #}
              <form id="add-kit-item" style="padding: 1em">
                <input type="hidden" name="scope" value="items">
                <div class="input-group">
                  <span class="input-group-addon"><i class="fa fa-barcode"></i></span>
                  <input type="text" class="form-control"
                         name="q" placeholder="Enter code or search terms">
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="button">Find Items</button>
                  </span>
                </div>
              </form>
              <table class="table table-striped table-header">
                <thead>
                  <th class="num">#</th>
                  <th>Code</th>
                  <th>Name</th>
                  <th class="text-right">Retail</th>
                  <th class="text-right">Sale</th>
                  <th class="text-right">Stock</th>
                  <th class="text-right">Quantity</th>
                </thead>
                {% set ext_sale, ext_retail, ext_quantity= 0, 0, 0 %}
                <tbody>
                  {% set kit_items= item.kit_items.find_many() %}
                  {% for k in kit_items|sort((b,a) => b.item.code <=> a.item.code) %}
                    {% set i = k.item %}
                    {% set ext_retail= ext_retail + (k.quantity * i.retail_price) %}
                    {% set ext_sale= ext_sale + (k.quantity * i.sale_price) %}
                    {% set ext_quantity= ext_quantity + k.quantity %}
                    <tr data-id="{{ k.id }}" data-editable-base="/catalog/item/{{ item.code }}/kit/{{ k.id}}" data-editable-reload="kit">
                      <td class="num">{{ loop.index }}</td>
                      <td>
                        <a href="{{ url_for('catalog-item', { 'code' : i.code }) }}">
                          {{- i.code -}}
                        </a>
                      </td>
                      <td>{{ i.name }}</td>
                      <td class="text-right">
                        {{ scat.amount(i.retail_price) }}
                      </td>
                      <td class="text-right">
                        {{ scat.amount(i.sale_price) }}
                      </td>
                      <td class="text-right">
                        {{ i.stock() }}
                      </td>
                      <td class="text-right">
                        <span class="editable" data-name="quantity">
                          {{- k.quantity -}}
                        </span>
                        <button class="btn btn-default btn-xs remove-kit-item">
                          <i class="fa fa-trash-o">
                            <span class="sr-only">Remove</span>
                          </i>
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr style="border-top: 6px double #dbcbb1">
                    <td colspan="4"></td>
                    <td class="text-right">{{ scat.amount(ext_retail) }}</td>
                    <td class="text-right">{{ scat.amount(ext_sale) }}</td>
                    <td class="text-right">{{ ext_quantity }}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          {% endblock %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Vendor Items -->
  <div class="panel-group" id="accordion"
       role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
      <div class="panel-heading" role="tab" id="vendorsHeader">
        <a class="accordion-toggle collapsed" role="button" data-toggle="collapse" href="#vendors" aria-expanded="false" aria-controls="vendors">
          <h4 class="panel-title">Vendors</h4>
        </a>
      </div>
      <div id="vendors" data-reload="vendors" class="panel-collapse collapse"
           role="tabpanel" aria-labelledby="vendorsHeader">
        {% block vendors %}
          {% import 'macros.twig' as scat %}
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th></th>
                <th>Company</th>
                <th>Code</th>
                <th>List</th>
                <th>Net</th>
                <th>Promo</th>
                <th>Sale</th>
                <th>Special?</th>
                <th>MOQ</th>
              </tr>
            </thead>
            <tfoot>
              <tr>
                <td colspan="9">
                  <button class="btn btn-primary"
                          data-action="edit-vendor-item">
                    Add Vendor Item
                  </button>
                  <button class="btn btn-primary"
                          data-action="attach-vendor-item">
                    Attach Vendor Item
                  </button>
                  <button class="btn btn-primary"
                          data-action="find-vendor-items">
                    Find Vendor Items
                  </button>
                </td>
              </tr>
            </tfoot>
            <tbody>
              {% for vi in item.vendor_items.find_many() %}
                {% set vendor= vi.vendor() %}
                <tr data-id="{{ vi.id }}">
                  <td>
                    <button type="button" class="btn btn-default btn-xs"
                            data-action="edit-vendor-item">
                      <i class="fa fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-default btn-xs"
                            data-action="unlink-vendor-item">
                      <i class="fa fa-unlink"></i>
                    </button>
                    {% if vendor.can_check_stock() %}
                      <a class="btn btn-default btn-xs"
                          role="button" tabindex="1"
                          data-action="check-vendor-stock">
                        <i class="fa fa-search"></i>
                      </a>
                    {% endif %}
                  </td>
                  <td>
                    <a href="/person/{{ vi.vendor_id }}">
                      {{ vendor.friendly_name }}
                    </a>
                  </td>
                  <td>{{ vi.code }}</td>
                  <td>{{ scat.amount(vi.retail_price) }}</td>
                  <td>{{ scat.amount(vi.net_price) }}</td>
                  <td>{{ scat.amount(vi.promo_price) }}</td>
                  <td>
                    {{ scat.amount(vi.net_price / 0.6) }} -
                    {{ scat.amount(vi.net_price / 0.5) }}
                  </td>
                  <td>
                    <i class="fa {{ vi.special_order ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
                  </td>
                  <td>{{ vi.purchase_quantity }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endblock %}
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="historyHeader">
      <a class="accordion-toggle collapsed" role="button" data-toggle="collapse" href="#history" aria-expanded="false" aria-controls="history">
        <h4 class="panel-title">History</h4>
      </a>
    </div>
    <div id="history" class="panel-collapse collapse collapsed" role="tabpanel" aria-labelledby="historyHeader">
      <table class="table table-striped table-header">
        <thead>
          <th class="num">#</th>
          <th>Date</th>
          <th>Transaction</th>
          <th>Person</th>
          <th class="text-right">Avg. Price</th>
          <th class="text-right">Quantity</th> 
          <th class="text-right">Running Total</th>
        </thead>
        <tbody>
          {% set running_total= 0 %}
          {% for txn in item.txns.find_many() %}
            <tr>
              <td class="num">{{ loop.index }}</td>
              <td>{{ txn.created }}</td>
              <td>
                <a href="/{{ txn.type == 'customer' ? 'sale' : 'purchase' }}/{{ txn.id }}">
                  {{ txn.friendly_type }}
                  {{ txn.formatted_number }}
                </a>
              </td>
              <td>
                {% if txn.person_id %}
                  <a href="/person/{{ txn.person_id }}">
                    {{ txn.person.friendly_name }}
                  </a>
                {% endif %}
              </td>
              <td class="text-right">
                {{ scat.amount(txn.sale_price) }}
              </td>
              <td class="text-right">
                {{ txn.quantity }}
              </td>
              <td class="text-right">
                {% set running_total= running_total + txn.quantity %}
                {{ running_total }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <button id="merge-item" class="btn btn-default">
    Merge Item
  </button>

{% endblock %}

{% block media %}
  {% set media= item.media %}
  {% if media is not empty %}
    {{ include('carousel.twig', { images: media, edit: 'edit-media' }) }}
  {% else %}
    {% set vi= item.vendor_items.where('vendor_id', 7).find_many() %}
    {% if item.has_vendor_with_salsify() %}
      <button class="btn btn-default btn-block" data-action="grab-media">
        <i class="fa fa-file-image-o fa-fw"></i>
        Grab from Salsify
      </button>
    {% endif %}
  {% endif %}
{% endblock %}

{% block pricing %}
  {% import 'macros.twig' as scat %}
  <div id="pricing">
    <h3 style="margin-top: 0">
      {% set cost= item.usual_cost %}
      {% if cost != 0 and item.sale_price != 0 %}
        {% set margin= ((item.sale_price - cost) / item.sale_price * 100) %}
        {% set label= "%.1f"|format(margin) ~ "%" %}
        {% set best= item.best_cost %}
        {% if best != cost %}
          {% set label= label ~ "(%.1f"|format((item.sale_price - best) / item.sale_price * 100) ~ "%)" %}
        {% endif %}
      {% endif %}

      {% set override= item.override_price %}
      {% if override %}
        <span class="text-danger">{{ scat.amount(override) }}</span>
        <s>
      {% endif %}
        <span class="editable {{ margin >= 50 ? 'text-success' : margin < 40 ? 'text-danger' }}"
              data-name="discount"
              data-reload="pricing"
              title="{{ label }}"
              data-value="{{ scat.format_discount(item) }}">
          {{- scat.amount(item.sale_price) -}}
        </span>
      {% if override %}
        </s>
      {% endif %}
      &nbsp;
      <small style="white-space: nowrap;">
        List Price
        <span class="editable"
              data-name="retail_price"
              data-reload="pricing">
          {{ scat.amount(item.retail_price) }}
        </span>
      </small>
    </h3>
    {% if item.retail_price != 0 and item.sale_price != item.retail_price %}
      <h4>
        Save {{ "%.0f"|format((item.retail_price - item.sale_price) / item.retail_price * 100) }}% off list
      </h4>
    {% endif %}

    {% set overrides= item.price_overrides.find_many %}
    {% if overrides|length %}
      <!-- TODO allow editing/removal from here -->
      <h4>Overrides</h4>
      <ul>
        {% for over in overrides %}
          <li style="{{ (over.in_stock and not item.stock()) ? 'text-decoration: line-through' }}">
            {{ scat.format_discount(over) }}
            for
            {{ over.minimum_quantity }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <button type="button" class="btn btn-link toggle"
            data-name="is_kit" data-value="{{ item.is_kit }}" data-reload-block="kit">
      <i class="fa fa-fw {{ item.is_kit ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      Kit?
    </button>
  </div><!-- /.pricing -->
{% endblock %}

{% block stock %}
  <div class="form-horizontal">
    <p>
      <span class="editable text-center" data-name="stock">
        {{- item.stock -}}
      </span> in stock.
    </p>

    <p>
      <span class="fake-editable text-center">
        {{- item.on_order -}}
      </span> on order.
    </p>

    <p>
      <span class="editable text-center" data-name="minimum_quantity">
        {{- item.minimum_quantity -}}
      </span> minimum stock.
    </p>

    <p>
      <span class="editable text-center" data-name="purchase_quantity">
        {{- item.purchase_quantity -}}
      </span> purchase quantity.
    </p>

    <p>
      {% if item.inventoried %}
        Inventoried {{ item.inventoried|date('l, M j, Y') }}
      {% else %}
        Never inventoried.
      {% endif %}
    </p>

    <button type="button" class="btn btn-link toggle"
            data-name="no_backorder" data-value="{{ item.no_backorder }}">
      <i class="fa fa-fw {{ item.no_backorder ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      No backorders?
    </button>

    <button type="button" class="btn btn-link toggle"
            data-name="no_online_sale" data-value="{{ item.no_online_sale }}">
      <i class="fa fa-fw {{ item.no_online_sale ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      No online sale?
    </button>

  </div>
{% endblock %}

{% block details %}
  <div id="details">
    <p>
      <b>Short name</b> &nbsp;
      <span class="editable" data-name="short_name">
        {{- item.short_name -}}
      </span>
    </p>

    <p>
      <b>Variation</b> &nbsp;
      <span class="editable" data-name="variation">
        {{- item.variation -}}
      </span>
    </p>

    <p>
      <b><abbr class="initialism" title="Taxability Information Code">TIC</abbr></b> &nbsp;
      <span class="editable" data-name="tic">
        {{- item.tic -}}
      </span>
    </p>

    {% block color %}
      <div id="color">
        <p>
          <b>Color</b>
          <span style="{{ item.color ? "background: #" ~ item.color }}">
            &nbsp; &nbsp; &nbsp;
          </span>
          &nbsp;
          <span class="editable" data-name="color" data-reload="color">
            {{- item.color -}}
          </span>
        </p>
      </div>
    {% endblock %}

    <p>
      <b>Weight (lbs)</b> &nbsp;
      <span class="editable" data-name="weight">
        {{- item.weight -}}
      </span>
    </p>

    <p>
      <b>Dimensions</b> &nbsp;
      <span class="editable" data-name="dimensions">
        {{- item.dimensions -}}
      </span>
    </p>

    <button type="button" class="btn btn-link toggle"
            data-name="packaged_for_shipping" data-value="{{ item.packaged_for_shipping }}">
      <i class="fa fa-fw {{ item.packaged_for_shipping ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      Packaged for Shipping
    </button>

    <p>
      {% if item.can_ship_free %}
        <b class="text-success">Can ship for free.</b>
      {% else %}
        <b class="text-danger">Cannot ship free.</b>
      {% endif %}
      <button class="btn btn-xs btn-default"
              data-action="shipping-estimate">
        <i class="fa fa-fw fa-plane"></i> Estimate
      </button>
    </p>

    <button type="button" class="btn btn-link toggle"
            data-name="prop65" data-value="{{ item.prop65 }}">
      <i class="fa fa-fw {{ item.prop65 ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      Prop. 65
    </button>
    <button type="button" class="btn btn-link toggle"
            data-name="hazmat" data-value="{{ item.hazmat }}">
      <i class="fa fa-fw {{ item.hazmat ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      Hazardous Material
    </button>
    <button type="button" class="btn btn-link toggle"
            data-name="oversized" data-value="{{ item.oversized }}">
      <i class="fa fa-fw {{ item.oversized ? 'fa-check-square-o' : 'fa-square-o' }}"></i>
      Oversized
    </button>
  </div>
{% endblock %}

{% block script %}
  <style>
    /* Have to force select2 higher than x-editable popup */
    .select2-container {
      z-index: 1080;
    }
    .btn-link {
      color: #333;
    }
    .editable {
      display: inline-block;
      text-decoration: inherit;
      min-width: 3em;
      min-height: 21px;
      border-bottom: 1px dashed #900;
    }
    .fake-editable {
      display: inline-block;
      padding-top: 5px;
      min-width: 3em;
      border-bottom: 1px dashed rgba(0,0,0,0.3);
    }
  </style>
  <script>
  {
    function reloadBlock(el, def) {
      let reload= el.closest('[data-reload]')
      if (reload) {
        reload= reload.getAttribute('data-reload')
        return fetch('/catalog/item/{{ item.code }}/?block=' + reload)
        .then((res) => {
          return res.text()
        })
        .then ((text) => {
          let html= scat.htmlToElement(text)
          // force panels open
          let panel= html.querySelector('.panel-collapse')
          if (panel)
            panel.classList.add('in')
          let div= document.getElementById(reload)
          div.replaceWith(html)
        })
      } else {
        el.innerText= def
        return Promise.resolve(el)
      }
    }

    function editableContent() {
      let el= this
      let name= el.getAttribute('data-name')
      let value= el.getAttribute('data-value')
      let type= el.getAttribute('data-editable-type') || 'text'
      if (!value) {
        value= this.innerText
      }
      let base_el= el.closest('[data-editable-base]')
      let base= (base_el ?
                  base_el.getAttribute('data-editable-base') :
                  "/catalog/item/{{ item.code }}")
      let reload_el= el.closest('[data-editable-reload]')

      let input= '<input type="text" name="" class="form-control" value="">'
      if (type == 'textarea') {
        input= '<textarea name="" class="form-control" cols="60" rows="5"></textarea>'
      }

      let html= scat.htmlToElement('<form><div class="form-group" style="margin-bottom: 0"><div class="input-group">' + input + '<span class="input-group-btn"><button type="submit" class="btn btn-success" style="margin-left: 0.75em"><i class="fa fa-fw fa-check"></i></button></span><span class="input-group-btn"><button type="button" class="btn btn-danger cancel"><i class="fa fa-fw fa-ban"></i></button></span></div><span class="help-block hidden" style="margin-bottom: 0"></span></div></form>')

      if (type == 'textarea') {
        html.querySelector('textarea').setAttribute('name', name)
        html.querySelector('textarea').innerText= value
      } else {
        html.querySelector('input').setAttribute('name', name)
        html.querySelector('input').setAttribute('value', value)
      }

      html.addEventListener('submit', (ev) => {
        ev.preventDefault()
        let formData= new FormData(ev.target)

        let btn= ev.target.querySelector('.fa-check')
        btn.classList.remove('fa-check')
        btn.classList.add('fa-spin','fa-spinner')
        scat.patch(base, formData)
            .then((res) => {
              if (res.redirected) {
                window.location.href= res.url
                return
              }
              return res.json()
            })
            .then((data) => {
              (($(el).popover('hide').data('bs.popover')||{}).inState||{}).click= false;
              return reloadBlock(reload_el ? reload_el : el, data[name])
            })
            .catch((err) => {
              let help= ev.target.querySelector('.help-block')
              help.innerText= err.message
              help.classList.remove('hidden')
              ev.target
                .querySelector('.form-group')
                .classList.add('has-error')
              btn.classList.remove('fa-spin','fa-spinner')
              btn.classList.add('fa-check')
            })
      })
      html.querySelector('.cancel').addEventListener('click', (ev) => {
        (($(el).popover('hide').data('bs.popover')||{}).inState||{}).click= false;
      })
      return html
    }

    function popoverPlacement(popover, el) {
      return el.getAttribute('data-placement') || 'auto right'
    }

    $('body').popover({
      selector: '.editable',
      content: editableContent,
      container: 'body',
      html: true,
      sanitize: false,
      placement: popoverPlacement,
    })
    .on('shown.bs.popover', (ev) => {
      // focus on the first input or select element
      let target= ev.target
      let id= ev.target.getAttribute('aria-describedby')
      let popover= document.getElementById(id)
      let input= popover.querySelector('input, select')
      if (input) { if (input.select) input.select(); input.focus(); }
      popover.dismisser= (ev) => {
        if (!popover.contains(ev.target)) {
          ev.stopPropagation(); ev.preventDefault();
          (($(target).popover('hide').data('bs.popover')||{}).inState||{}).click= false;
        }
      }
      document.addEventListener('click', popover.dismisser, true)
    })
    .on('hide.bs.popover', (ev) => {
      let id= ev.target.getAttribute('aria-describedby')
      let popover= document.getElementById(id)
      if (popover && popover.dismisser)
        document.removeEventListener('click', popover.dismisser, true)
    })

    $('.editable-select2').editable({
      pk: '{{ item.code }}',
      url: (params) => {
        return fetch("/catalog/item/" + params.pk, {
          method: 'PATCH',
          headers: {
            'Content-type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ [params.name] : params.value })
        })
        .then((res) => res.json())
      },
      tpl: '<select></select>',
      select2: {
        width: '30em',
        ajax: {
          url: "/catalog/search?scope=products",
          dataType: 'json',
          processResults: function (data) {
            return {
              results: data.products.map((d) => {
                return { id: d.id, text: d.name }
              })
            }
          }
        },
      },
      success: (response, newValue) => {
        if (response.error) { return response.error }
        window.location.reload()
      }
    })
    .on('shown', function (e, editable) {
      // Can't just do this directly because $input isn't focused yet
      setTimeout(function() {
        editable.input.$input.select2('focus')
      }, 1)
    });

    let handleToggle= (toggle) => {
      let current= toggle.getAttribute('data-value')

      let name= toggle.getAttribute('data-name')
      let value= current === '1' ? 0 : 1

      let icon= toggle.querySelector('i')
      icon.classList.remove('fa-square-o','fa-check-square-o')
      icon.classList.add('fa-spin','fa-spinner')

      return fetch("/catalog/item/{{ item.code }}", {
        method: 'PATCH',
        headers: {
          'Content-type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ [name] : value })
      })
      .then((res) => res.json())
      .then((data) => {
        icon.classList.remove('fa-spin','fa-spinner')
        icon.classList.add(data[name] !== 0 ?
                           'fa-check-square-o' : 'fa-square-o')
        toggle.setAttribute('data-value', data[name])

        let reload= toggle.closest('[data-reload-block]').getAttribute('data-reload-block')
        if (reload) {
          scat.reload(reload)
        }
      })
    }

    document.addEventListener('click', (ev) => {
      let toggle= ev.target.closest('.toggle')
      if (toggle) handleToggle(toggle)
    })

    $('.edit-barcode-quantity').editable({
      url: (params) => {
        return fetch("/catalog/item/{{ item.code }}/barcode/" + params.pk, {
          method: 'PATCH',
          headers: {
            'Content-type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ [params.name] : params.value })
        })
      },
    })
    .on('shown', function (e, editable) {
      // Can't just do this directly because $input isn't focused yet
      setTimeout(function() {
        editable.input.$input.select()
      }, 1)
    });

    let removeBarcode= (barcode) => {
      return scat.delete("/catalog/item/{{ item.code }}/barcode/" + barcode)
            .then((res) => {
              scat.reload('barcodes')
            })
    }
    document.addEventListener('click', (ev) => {
      if (ev.target.closest('.remove-barcode')) {
        let barcode= ev.target.closest('[data-barcode]')
        return removeBarcode(barcode.getAttribute('data-barcode'))
      }
    })

    document.querySelector('#new-barcode').addEventListener('click', (ev) => {
      let barcode= window.prompt("What's the new barcode?", "")
      if (!barcode) { return }

      return scat.call('/catalog/item/{{ item.code }}/barcode', { barcode: barcode })
      .then((res) => {
        scat.reload('barcodes')
      })
      .catch((err) => {
        scat.alert('danger', err.message)
      })
    })

    scat.handleAction('click', 'find-vendor-items', (act) => {
      return scat.call('/catalog/item/{{ item.code }}/vendor-item', {})
        .then((res) => {
          scat.reload('vendors')
        })
    })

    scat.handleAction('click', 'edit-vendor-item', (act) => {
        let vi= act.closest('[data-id]')
        let id= vi ? vi.getAttribute('data-id') : 0
        return scat.dialog('/catalog/vendor-item' + (id ? '/' + id : ''), {
          item_id: {{ item.id }}
        })
    })

    scat.handleAction('click', 'attach-vendor-item', (act) => {
        let vi= act.closest('[data-id]')
        let id= vi ? vi.getAttribute('data-id') : 0
        return scat.dialog('/catalog/vendor-item/search')
          .then((vendor_item_id) => {
            return scat.patch('/catalog/vendor-item/' + vendor_item_id, { item_id: {{ item.id }} })
          })
          .then((res) => {
            scat.reload('vendors')
          })
    })

    scat.handleAction('click', 'unlink-vendor-item', (act) => {
      let id= act.closest('[data-id]').getAttribute('data-id')
      return scat.delete("/catalog/item/{{ item.code }}/vendor-item/" + id)
                  .then((res) => {
                    scat.reload('vendors')
                  })
    })

    scat.handleAction('click', 'check-vendor-stock', (act) => {
      let id= act.closest('[data-id]').getAttribute('data-id')
      return scat.get('/catalog/vendor-item/' + id + '/stock')
      .then((res) => res.json())
      .then((data) => {
        message= "";
        for (const [key, value] of Object.entries(data)) {
          message+= `${value} in ${key}` + "<br>";
        }
        return scat.popover(act, {
          title: 'Stock',
          content: message,
          html: true,
        })
      })
    })

    document.getElementById('merge-item').addEventListener('click', (ev) => {
      let to= window.prompt("What item should we merge this into?", "")
      if (to) {
        scat.post('/catalog/item/' + to + '/~merge',
                  { from: '{{ item.code }}' })
            .then((res) => res.json())
            .then((data) => {
              window.location.href= data.code
            })
            .catch((err) => {
              scat.alert('danger', err.message)
            })
      }
    })

    /* Kit handling */
    document.addEventListener('submit', (ev) => {
      if (ev.target.id != 'add-kit-item') return;

      ev.stopPropagation()
      ev.preventDefault()

      let form= ev.target

      form.classList.remove('has-error')

      scat.get('/catalog/search', new FormData(form), {
        headers: {
          'Content-type': 'application/json',
          'Accept': 'application/json'
        }
      })
      .then((res) => res.json())
      .then((data) => {
        if (!data.items.length) {
          form.classList.add('has-error')
        } else if (data.items.length == 1) {
          return scat.post('/catalog/item/{{ item.code }}/kit', {
            id: data.items[0].id
          })
          .then((res) => {
            scat.reload('kit')
          })
        } else {
          scat.alert('warning', 'Too many matches!')
        }
      })
      .catch((err) => {
        scat.alert('danger', err.message)
      })
    })

    document.addEventListener('click', (ev) => {
      if (ev.target.closest('.remove-kit-item')) {
        let id= ev.target.closest('[data-id]').getAttribute('data-id')
        return scat.delete("/catalog/item/{{ item.code }}/kit/" + id)
            .then((res) => {
              scat.reload('kit')
            })
      }
    })

    scat.handleAction('click', 'print-labels', (act) => {
      // Get selected items and other options
      let half= (act.getAttribute('data-size') == 'half')
      let items= [ {{ item.id }} ]
      let noprice= act.getAttribute('data-noprice')
      let short= act.getAttribute('data-short')
      let trim= act.getAttribute('data-trim')
      if (trim === 'ask') {
        trim= window.prompt("Please enter the part of the name to trim from the labels", "");
      }
      let quantity= act.getAttribute('data-quantity')
      if (quantity === 'ask') {
        quantity= window.prompt("How many labels do you want to print?", "");
        if (quantity === null) {
          return
        }
      }
      if (!Number(quantity)) {
        quantity= 1
      }
      // trim, noprice, size
      return scat.print('/catalog/~print-labels', {
        items: items,
        half: half,
        noprice: noprice,
        short: short,
        trim: trim,
        quantity: quantity
      })
    })
  }

  scat.handleAction('click', 'edit-media', (act) => {
    return scat.dialog('/catalog/item/{{ item.code }}/media')
  })

  scat.handleAction('click', 'grab-media', (act) => {
    return scat.dialog('/catalog/item/{{ item.code }}/media?grab=1')
  })

  scat.handleAction('click', 'google-history', (act) => {
    return scat.dialog('/catalog/item/{{ item.code }}/googleHistory')
        .catch((err) => {
          scat.alert('danger', err.message)
        })
  })

  scat.handleAction('click', 'shipping-estimate', (act) => {
    return scat.dialog('/catalog/item/{{ item.code }}/shippingEstimate')
        .catch((err) => {
          scat.alert('danger', err.message)
        })
  })
  </script>

  {{ scat.file_upload('/catalog/item/' ~ item.code ~ '/media') }}
{% endblock %}
